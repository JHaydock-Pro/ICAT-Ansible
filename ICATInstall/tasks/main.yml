---
#Master file for ICATInstall

#---NOTES---
#playbooks are currently separated by os-family, any playbooks that will work across all relevent OSs should be moved to 'Universal' (or 'Linux'/'Windows'/'Mac')
#Variables are currently stored in a single YAML file, these should be separated by OS (eg. Ubuntu, Debian etc) or by function (eg. logins, package versions etc)

#---TODO---
# Check which plays need separate install for other OSs
# Move universal plays to apropriate directory
# If the entire role has very little change needed for different OSs use universal and run OS checks on individual tasks
# Organise variables for easy customisation
# Improve non-fresh install checking to skip tasks rather than ignoring errors
# Improve feedback



#---Plays---

#---Update Package Lists---

- name: "{{ play_name }}Updating package list for RedHat"
  yum:
    name: '*'
    state: latest
  when: ansible_os_family == 'RedHat'
  vars:
    play_name: "Update : "
  tags:
    - setup
    - root
    - update
    - redhat
    - tested

- name: "{{ play_name }}Updating package cache for Debian"
  apt:
    update_cache: yes
  become: yes
  become_user: root
  become_method: sudo
  when: ansible_os_family == "Debian"
  vars:
    play_name: "Update : "
  tags:
   - setup
   - root
   - update
   - debian
   - tested


#---Install java---

- name: "{{ play_name }}Loading Java Install"
  include: "java.yml"
  vars:
    play_name: "Java : "
  tags:
    - root
    - java
    - tested


#---Install MySQL---

- name: "{{ play_name }}Loading Pexpect Install"
  include: "pexpect.yml"
  vars:
    play_name: "MySQl Pexpect : "
  tags:
    - root
    - mysql
    - python
    - tested

- name: "{{ play_name }}Loading MySQl Install and Config"
  include: "mysql.yml"
  vars:
    play_name: "MySQL : "
  tags:
    - root
    - mysql  
    - tested


#---Creating non-root user

- name: "{{ play_name }}Loading Non-Root User Creation"
  include: "user.yml"
  vars:
    play_name: "Non-Root User : "
  tags:
    - createuser
    - tested


#---Glassfish---

- name: "{{ play_name }}Loading Glassfish install" 
  include: "glassfish.yml" 
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "Glassfish : "
  tags:
    - user
    - glassfish
    - tested


#---Authentication---

- set_fact:
    authn_plugin: simple      #---TODO!---move this to a config/variable file for easy change
  tags:
    - user
    - authn
    - tested

- name: "{{ play_name }}Loading Simple Authenticaton install"
  include: "simpleauthn.yml"
  become: yes
  become_user: "{{ user_name }}"
  when: authn_plugin == "simple"
  vars:
    play_name: "Authn Simple : "
  tags:
    - user
    - authn
    - tested

- name: "{{ play_name }}Loading OTHER Authenticaton install"
  include: "{{ ansible_os_family }}/otherauthn.yml"
  become: yes
  become_user: "{{ user_name }}"
  when: authn_plugin == "other"
  tags:
    - user
    - authn
    - tested


#---ICATServer---

- name: "{{ play_name }}Loading ICAT server install"
  include: "icatserver.yml"
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "ICAT Server : "
  tags:
    - user
    - icat
    - tested


#---Storage Plugin---

- name: "{{ play_name }}Loading Storage Plugin Install"
  include: "storage.yml"
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "IDS Storage : "
  tags:
    - user
    - storage
    - tested


#---IDS---

- name: "{{ play_name }}Loading IDS Install"
  include: "ids.yml"
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "IDS : "
  tags:
    - user
    - ids
    - tested


#---Test Data---

- name: "{{ play_name }}Loading Test Data Install"
  include: "lorem.yml"
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "TestData : "
  tags:
    - user
    - test
    - broken


#---TopCat---

- name: "{{ play_name }}Loading TopCat Install"
  include: "topcat.yml"
  become: yes
  become_user: "{{ user_name }}"
  vars:
    play_name: "TopCat : "
  tags:
    - user
    - topcat
    - tested


#---Cleanup---
#removing downloads, scripts and zip files that are no longer needed
