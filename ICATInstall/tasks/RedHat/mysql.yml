---

- name: "{{ play_name }}Installing MySQL Packages - Specifically '{{ mysql_packages }}'"
  yum:
    name: "{{ mysql_packages }}"
    state: latest

- name: "{{ play_name }}Removing default engine setting"
  lineinfile:
    path: "{{ mysql_cnf_path }}"
    state: absent
    regexp: 'default_storage_engine ='

- name: "{{ play_name }}Setting default engine to '{{ mysql_cnf_eng }}'"
  lineinfile:
    path: /etc/my.cnf
    insertafter: '[mysqld] '
    line: default_storage_engine = {{ mysql_cnf_eng }}

- name: "{{ play_name }}Starting database"
  service:
    name: mysqld
    state: started

#TODO! - Improve this task so it doesn't run at all if not first install
- name: "{{ play_name }}Temporarly reseting MySQL root password (This will return an error on first run but should ignore it)"
  command: "mysqladmin -u root -p'{{ mysql_root_pass }}' password ''"
  ignore_errors: true

- name: "{{ play_name }}Running '{{ mysql_secure }}'"
  expect:
    command: mysql_secure_installation
    responses:
      'Enter current password for root \(enter for none\):': "\n"
      'Set root password?': 'y'
      'New password:': "{{ mysql_root_pass }}"
      'Re-enter new password:': "{{ mysql_root_pass }}"
      'Remove anonymous users?': 'y'
      'Disallow root login remotely?': 'y'
      'Remove test database and access to it?': 'y'
      'Reload privilege tables now?': 'y'

- name: "{{ play_name }}Creating database - {{ mysql_db_name }}"
  mysql_db:
    login_user: root
    login_password: "{{ mysql_root_pass }}"
    name: "{{ mysql_db_name }}"
    state: present

- name: "{{ play_name }}Creating Database login - user={{ mysql_user }} pass={{ mysql_pass }}"
  mysql_user:
    login_user: root
    login_password: "{{ mysql_root_pass }}"
    name: "{{ mysql_user }}"
    password: "{{ mysql_pass }}"
    priv: '*.*:ALL,GRANT'
    state: present

