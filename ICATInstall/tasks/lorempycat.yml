---

- name: "{{ play_name }}Downloading Python ICAT"
  get_url:
    url: "{{ pycat_url }}"
    dest: /root/
  become: yes
  become_user: root
  become_method: sudo

- name: "{{ play_name }}Unzipping {{ pycat_zip }}"
  unarchive:
    src: "{{ pycat_zip }}"
    dest: "/root/"
    owner: root
    group: root
  become: yes
  become_user: root
  become_method: sudo

- name: "{{ play_name }}Installing dependencies"
  pip:
    name: "{{ item }}"
    state: latest
  with_items:
    - suds-jurko
    - PyYAML
  become: yes
  become_user: root
  #become_method: sudo

- name: "{{ play_name }}Installing dependencies for RedHat"
  yum:
    name: "{{ item }}"
    state: latest
  with_items:
    - python-argparse
    - python-lxml
  when: ansible_os_family == "RedHat"
  become: yes
  become_user: root
  become_method: sudo
  tags:
    - redhat

- name: "{{ play_name }}Installing dependencies for Debian"
  apt:
    name: "{{ item }}"
    state: latest
  with_items:
    - python-argparse
    - python-lxml
  when: ansible_os_family == "Debian"
  become: yes
  become_user: root
  become_method: sudo
  tags:
    - debian

- name: "{{ play_name }}Checking Python version"
  command: python --version
  register: pyv

- name: "{{ play_name }}Patching for Python 2.6"
  patch:
    src: "{{ pycat_path }}/python2_6.patch"
    basedir: "{{ pycat_path }}/"
    remote_src: yes
    strip: 1
  become: yes
  become_user: root
  become_method: sudo
  when: '"2.6." in pyv.stderr'

- name: "{{ play_name }}Modifiying ICAT Ingest"
  replace:
    path: "{{ pycat_path }}/icatingest.py"
    regexp: "default='THROW'"
    replace: "default='IGNORE'"
  become: yes
  become_user: root
  become_method: sudo

- name: "{{ play_name }}Building and Installing Python ICAT"
  command: "python setup.py {{ item }}"
  args:
    chdir: "{{ pycat_path }}"
  with_items:
    - build
    - install
  become: yes
  become_user: root
  become_method: sudo

- name: "{{ play_name }}Copying Dump file"
  copy:
    src: ../files/lils.yml
    dest: "/home/{{ user_name }}/"

- name: "{{ play_name }}Running ICAT ingest"
  command: 'icatingest.py --url "http://localhost:8080/ICATService/ICAT?wsdl" -u root -p {{ mysql_root_pass }} -i lils.yml -a simple'
