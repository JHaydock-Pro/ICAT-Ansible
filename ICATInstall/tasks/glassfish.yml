---

- name: "{{ play_name }}Loading Pre-playbook Check"
  include: "preplay.yml"

#---Setting Variables for RedHat/Debian---

- name: "{{ play_name }}Setting variables for RedHat"
  set_fact:
     script_path: setup-glassfish.py
     glassfish_java: "{{ glassfish_java_redhat }}"
  when: ansible_os_family == "RedHat"
  tags:
    - redhat

- name: "{{ play_name }}Setting variable for Debian"
  set_fact:
    script_path: "~/setup-glassfish.py"
    glassfish_java: "{{ glassfish_java_debian }}"
  when: ansible_os_family == "Debian"   

#---

#---Download Glassfish---

- stat:
    path: "{{ download_dir }}{{ glassfish_zip }}"
  register: gf_zip

- name: "{{ play_name }}Downloading Glassfish"
  get_url:
    url: "{{ glassfish_src }}"
    dest: "{{ download_dir }}"
  when: gf_zip.stat.exists == false

#---

#---Unzip Glassfish---

- stat:
    path: "{{ glassfish_path }}"
  register: gf_dir

- name: "{{ play_name }}Unzipping {{ glassfish_zip }}"
  unarchive:
    src: "{{ download_dir }}{{ glassfish_zip }}"
    dest: "{{ user_home }}"
    remote_src: yes
  when:
    - gf_dir.stat.exists == false

#---

#---Download Glassfish setup script---

- stat:
    path: "{{ script_path }}"
  register: gf_script

- name: "{{ play_name }}Downloading Glassfish setup script"
  get_url:
    url: "{{ glassfish_setup }}"
    dest: "{{ user_home }}"
  when: gf_script.stat.exists == false

#---

#---Run Glassfish setup script---

- stat:
    path: "{{ glassfish_path }}/glassfish/domains/{{ glassfish_domain }}"
  register: gf_dom

- name: "{{ play_name }}Stopping {{ glassfish_domain }}"
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ glassfish_path }}/bin"
  command: "nohup asadmin stop-domain {{ glassfish_domain }}"
  when: gf_dom.stat.exists == true

- name: "{{ play_name }}Running setup script"
  environment:
    PATH: "{{ ansible_env.PATH }}:/home/{{ user_name }}/glassfish4/bin"
  command: python {{ script_path }} {{ glassfish_domain }} 75% {{ mysql_root_pass }}

#---

#---Configuring Glassfish Domain---

- name: "{{ play_name }}Configuring {{ glassfish_domain }} for MySQL"
  copy:
    src: "{{ glassfish_java }}"
    dest: "{{ glassfish_path }}/glassfish/domains/{{ glassfish_domain }}/lib/ext/"
    remote_src: yes

- name: "{{ play_name }}Restarting {{ glassfish_domain }}"
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ glassfish_path }}/bin"
  command: "nohup {{ item }}"
  with_items:
  - "asadmin restart-domain {{ glassfish_domain }}"
  - "asadmin list-domains"
  
#---
