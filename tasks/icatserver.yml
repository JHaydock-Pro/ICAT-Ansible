---

- name: "{{ play_name }}Loading Pre-playbook Check"
  include: "preplay.yml"

#---

#---Downloading ICAT Server---

- stat:
    path: "{{ download_dir }}{{ icat_zip }}"
  register: is_zip

- name: "{{ play_name }}Downloading {{ icat_zip }}"
  get_url:
    url: "{{ icat_src }}"
    dest: "{{ download_dir }}"
  when: is_zip.stat.exists == false

#---

#---Unzipping Icat Server---

- stat:
    path: "{{ icat_path }}"
  register: is_dir

- name: "{{ play_name }}Unzipping {{ icat_zip }}"
  unarchive:
    src: "{{ download_dir }}{{ icat_zip }}"
    dest: "{{ user_home }}/"
    remote_src: yes
  when: is_dir.stat.exists == false

#---

#---Setup file---

- stat:
    path: "{{ icat_path }}/{{ icat_setup }}"
  register: is_setup

- name: "{{ play_name }}Copying {{ icat_setup }}.example"
  copy:
    src: "{{ icat_path }}/{{ icat_setup }}.example"
    dest: "{{ icat_path }}/{{ icat_setup }}"
    remote_src: yes
  when:
    - is_setup.stat.exists == false

- name: "{{ play_name }}Configuring {{ icat_setup }}"
  lineinfile:
    path: "{{ icat_path }}/{{ icat_setup }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items: "{{ icat_cnf_list }}"

#---

#---Lucene Directory---

- name: "{{ play_name }}Creating Lucene directory"
  file: 
    path: "{{ lucene_dir }}"
    state: directory

#---

#---Script Directory---

- name: "{{ play_name }}Creating script directory"
  file:
    path: "{{ user_home }}/bin"
    state: directory

- name: "{{ play_name }}Adding script directory to bashrc"
  lineinfile:
    path: "{{ user_home }}/.bashrc"
    line: "export PATH=$PATH:{{ user_home }}/bin"

#---

#---Icat Properties---

- name: "{{ play_name }}Creating {{ icat_prop }}"
  copy:
    src: "{{ icat_path }}/{{ icat_prop }}.example"
    dest: "{{ icat_path }}/{{ icat_prop }}"
    remote_src: yes
    force: no

- name: "{{ play_name }}Configuring {{ icat_prop }}"
  lineinfile:
    dest: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: 'rootUserNames', line: 'rootUserNames = {{ icat_mech }}/{{ icat_root }}' }
    - { regexp: 'lucene.directory', line: 'lucene.directory = {{ lucene_dir }}' }

#--authn list--

- set_fact:
    authn_list:

- set_fact:
    authn_list: "{{ authn_list }} simple"
  when: authn_simple == true

- set_fact:
    authn_list: "{{ authn_list }} db"
  when: authn_db == true

- set_fact:
    authn_list: "{{ authn_list }} ldap"
  when: authn_ldap == true

- set_fact:
    authn_list: "{{ authn_list }} anon"
  when: authn_anon == true

- name: "{{ play_name }}Setting Authn List to {{ authn_list }}"
  lineinfile:
    dest: "{{ icat_path }}/{{ icat_prop }}"
    regexp: authn.list
    line: "authn.list = {{ authn_list }}"

#--

#--Authn Simple--

- name: "{{ play_name }}Configuring {{ icat_prop }} - adding authn.simple.friendly line"
  lineinfile:
    dest: "{{ icat_path }}/{{ icat_prop }}"
    insertafter: 'authn.simple.jndi'
    line: 'authn.simple.friendly = Simple'
 
- name: "{{ play_name }}Configuring {{ icat_prop }} - Uncommenting Authn Simple Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^!authn.simple"
    replace: "authn.simple"
  when: authn_simple == true

- name: "{{ play_name }}Configuring {{ icat_prop }} - Commenting Out Authn Simple Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^authn.simple"
    replace: "!authn.simple"
  when: authn_simple == false

#--

#--Authn DB--

- name: "{{ play_name }}Configuring {{ icat_prop }} - Uncommenting Authn DB Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^!authn.db"
    replace: "authn.db"
  when: authn_db == true

- name: "{{ play_name }}Configuring {{ icat_prop }} - Commenting Out Authn DB Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^authn.db"
    replace: "!authn.db"
  when: authn_db == false

#--

#--Authn LDAP--

- name: "{{ play_name }}Configuring {{ icat_prop }} - Uncommenting Authn LDAP Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^!authn.ldap"
    replace: "authn.ldap"
  when: authn_ldap == true

- name: "{{ play_name }}Configuring {{ icat_prop }} - Commenting Out Authn LDAP Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^authn.ldap"
    replace: "!authn.ldap"
  when: authn_ldap == false

#--

#--Authn Anon--

- name: "{{ play_name }}Configuring {{ icat_prop }} - Uncommenting Authn Anon Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^!authn.anon"
    replace: "authn.anon"
  when: authn_anon == true

- name: "{{ play_name }}Configuring {{ icat_prop }} - Commenting Out Authn Anon Lines"
  replace:
    path: "{{ icat_path }}/{{ icat_prop }}"
    regexp: "^authn.anon"
    replace: "!authn.anon"
  when: authn_anon == false

#--

#---

#---Running Setup---

- name: "{{ play_name }}Installing ICAT server"
  shell:
    cmd: ./setup install
    chdir: "{{ icat_path }}"

- name: "{{ play_name }}Checking ICAT"
  command: "curl -k {{ icat_url }}/icat/version"
  register: icat_out

#---
