---

- name: "{{ play_name }}Loading Pre-playbook Check"
  include: "preplay.yml"

#---

#-NOTE-if for whatever reason a plugin's variables don't match the standard format in defaults/suthn.yml, add them here
 # eg. Chosen version of authn anon has different url, add 'authn_src: {NEW URL}' to the anon set_fact below

- name: "{{ play_name }}Setting Variables for Authn Simple"
  set_fact:
    authn_version: "{{ simple_version }}"
    authn_users_s: 
  when: authn_plugin == "simple"

- name: "{{ play_name }}Setting Variables for Authn DB"
  set_fact:
    authn_version: "{{ db_version }}"
    authn_cnf_list: "{{ authn_cnf_list }} + {{ mysql_cnf_list | replace('target','vendor') }}"
  when: authn_plugin == "db"

- name: "{{ play_name }}Setting Variables for Authn LDAP"
  set_fact:
    authn_version: "{{ ldap_version }}"
  when: authn_plugin == "ldap"

- name: "{{ play_name }}Setting Variables for Authn Anon"
  set_fact:
    authn_version: "{{ anon_version }}"
  when: authn_plugin == "anon"

#---

#---Downloading Authn---

- stat:
    path: "{{ download_dir }}{{ authn_zip }}"
  register: sa_zip

- name: "{{ play_name }}Downloading {{ authn_zip }}"
  get_url:
    url: "{{ authn_src }}"
    dest: "{{ download_dir }}"
  when: sa_zip.stat.exists == false

#---

#---Unzipping Authn---

- stat:
    path: "{{ authn_path }}"
  register: sa_dir

- name: "{{ play_name }}Unzipping {{ authn_zip }}"
  unarchive:
    src: "{{ download_dir }}{{ authn_zip }}"
    dest: "{{ user_home }}"
    remote_src: yes
  when: sa_dir.stat.exists == false

#---

#---Setup-Properties---

- stat:
    path: "{{ authn_path }}/{{ authn_setup }}"
  register: a_setup

- name: "{{ play_name }}Copying {{ authn_setup }}.example"
  copy:
    src: "{{ authn_path }}/{{ authn_setup }}.example"
    dest: "{{ authn_path }}/{{ authn_setup }}"
    remote_src: yes
  when:
    - a_setup.stat.exists == false

- name: "{{ play_name }}Configuring {{ authn_setup }}"
  lineinfile:
    path: "{{ authn_path }}/{{ authn_setup }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items: "{{ authn_cnf_list }}"

#---

#---Properties---

- name: "{{ play_name }}Copying {{ authn_prop }}.example"
  copy:
    src: "{{ authn_path }}/{{ authn_prop }}.example"
    dest: "{{ authn_path }}/{{ authn_prop }}"
    remote_src: yes
    force: no

#---

#---Setup Users---

#--Simple--

- name: "{{ play_name }}Gathering User list for Authn Simple (Simple Only)"
  set_fact:
    authn_users_s: "{{ authn_users_s }} {{ item.user }}"
  with_items:
    - "{{ authn_simple_users }}"
  when: authn_plugin == "simple"
  tags:
    - simple

- name: "{{ play_name }}Creating usernames in {{ authn_prop }} (Simple Only)"
  lineinfile:
    path: "{{ authn_path }}/{{ authn_prop }}"
    regexp: 'user.list'
    line: "user.list = {{ authn_users_s }}"
  when: authn_plugin == "simple"      
  tags:
    - simple

- name: "{{ play_name }}Adding passwords to {{ authn_prop }} (Simple Only)"
  lineinfile:
    path: "{{ authn_path }}/{{ authn_prop }}"
    regexp: "user.{{ item.user }}"
    line: "user.{{ item.user }}.password = {{ item.pass }}"
    insertafter: "usere"
  with_items:
    - "{{ authn_simple_users }}"
  when: authn_plugin == "simple"
  tags:
    - simple


#--DB--

- stat:
    path: "{{ download_dir }}/PASSWD.text"
  register: ps_txt

- name: "{{ play_name }}Creating list of Users and Passwords for import (DB Only)"
  file:
    path: "{{ download_dir }}/PASSWD.text"
    state: touch
  when: 
    - authn_plugin == "db"
    - ps_txt.stat.exists == false
  tags:
    - db

- name: "{{ play_name }}Adding users and passwords to file for import (DB Only)"
  lineinfile:
    path: "{{ download_dir }}/PASSWD.text"
    regexp: "^{{ item.user }}"
    line: "{{ item.user }},{{ item.pass }}"
  with_items:
    - "{{ authn_db_users }}"
  when: authn_plugin == "db"
  tags:
    - db
 
- name: "{{ play_name }}Copying file for database import (DB Only)"
  template:
    src: "../templates/passwd.sql"
    dest: "{{ download_dir }}"
  when: authn_plugin == "db"
  tags:
    - db

- name: "{{ play_name }}Deleting PASSWD table if requested (DB Only)"
  lineinfile:
    path: "{{ download_dir }}passwd.sql"
    regexp: "^drop table PASSWD"
    insertbefore: "^create"
    line: "drop table if exists PASSWD;"
  when: 
    - authn_plugin == "db"
    - delete_passwd == true
  tags:
    - db
  
- name: "{{ play_name}}Deleting duplicate users in PASSWD if requested (DB Only)"
  lineinfile:
    path: "{{ download_dir }}passwd.sql"
    regexp: "{{ item.user }}"
    insertbefore: "^create"
    line: "DELETE from PASSWD where UserName = '{{ item.user }}';"
  with_items: 
   - "{{ authn_db_users }}" 
  when: 
    - authn_plugin == "db"
    - delete_users == true 
  tags:
    - db

- name: "{{ play_name }}Importing data into PASSWD table (DB Only)"
  mysql_db:
    state: import
    target: "{{ download_dir }}passwd.sql"
    login_user: root
    login_password: "{{ mysql_root_pass }}"
    name: "{{ icat_name }}"
  when: authn_plugin == "db"
  tags:
    - db


#--LDAP--

- name: "{{ play_name }}Adding Ldap server to {{ authn_prop }} (LDAP Only)"
  lineinfile:
    path: "{{ authn_path }}/{{ authn_prop }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  with_items:
    - { regexp: "provider_url",       line: "provider_url = {{ ldap_provider }}" }
    - { regexp: "security_principal", line: "security_principal = {{ ldap_principal }}" }
  when: authn_plugin == "ldap"

#--Anon--

#No user setup required

#---

#---Running Setup---

- name: "{{ play_name }}Installing {{ authn_plugin }} Authentication"
  shell:
    cmd: ./setup install
    chdir: "{{ authn_path }}"

#---
